AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  This template creates the a non-production application server for the Ed-Fi ODS/API
  Software Suite.  ** WARNING **  You will be billed for the AWS resources that are
  created from this template.  There is no cost to use this template, but are responsible
  for the costs incurred by the resources created in this template.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Network Configuration
        Parameters:
          - VPCID
          - WebServerSubnetId
          - WebServerSecurityGroup
      - Label:
          default: Webserver Configuration
        Parameters:
          - AdminUser
          - AdminPassword
          - WebServerInstanceType
          - KeyPair
      - Label:
          default: EdFi ODS API Configuration
        Parameters:
          - EnvLabel
          - DomainNameURL
          - DBEndpointAddress
          - DBUsername
          - DBPassword
          - UseSwagger
      - Label:
          default: EdFi Quick Deploy Configuration
        Parameters:
          - S3BucketName
    ParameterLabels:
      EnvLabel:
        default: Label your environment
      AdminUser:
        default: The Local Admin Account Username
      AdminPassword:
        default: The Local Administrator password for a new user
      WebServerSubnetId:
        default: Subnet ID to Launch the Instance
      WebServerSecurityGroup:
        default: The Security Group ID of the Application Servers
      VPCID:
        default: The VPC ID to use for the resources
      WebServerInstanceType:
        default: The EC2 instance type of the Application Server
      KeyPair:
        default: EC2 KeyPair to assign to the instances
      DomainNameURL:
        default: Domain Name of the ODS API environment
      DBEndpointAddress:
        default: The RDS endpoint for the environment
      DBUsername:
        default: Database account username
      DBPassword:
        default: Database account password
      UseSwagger:
        default: Should the SwaggerUI be installed
      S3BucketName:
        default: The S3 bucket that provides the ODS API resources
Parameters:
  EnvLabel:
    Default: ''
    Type: String
    Description: Provide a label for your environment to identify resources easier.
  UseSwagger:
    AllowedValues:
      - 'yes'
      - 'no'
    Default: 'no'
    Description: Should the SwaggerUI be installed? (not recommended for Production
      environments).
    Type: String
  AdminUser:
    Description: User name for the new local administrator account
    Type: String
    Default: LocalAdmin
    MinLength: '5'
    MaxLength: '25'
    AllowedPattern: '[a-zA-Z0-9]*'
  AdminPassword:
    Description: Password for the ODS API Application local administrative account.
      Must be at least 8 characters containing letters, numbers and symbols
    Type: String
    MinLength: '8'
    MaxLength: '32'
    AllowedPattern: (?=^.{6,255}$)((?=.*\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*
    NoEcho: 'true'
  S3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: AWS S3 bucket name can include numbers, lowercase letters,
      uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Default: edfi-aws-quick-deploy
    Description: S3 bucket name for the EdFi Quick Deploy assets. AWS S3 bucket name
      can include numbers, lowercase letters, uppercase letters, and hyphens (-).
      It cannot start or end with a hyphen (-).
    Type: String
  WebServerSubnetId:
    ConstraintDescription: Must be an existing Subnet Ids
    Default: ''
    Description: A subnet id of Amazon VPC where the WebServer would be launched.
    Type: AWS::EC2::Subnet::Id
  WebServerInstanceType:
    AllowedValues:
      - t3.medium
      - t3.large
      - t2.medium
      - t2.large
      - m5.large
      - m5.xlarge
    ConstraintDescription: Choose an instance type.
    Default: t2.medium
    Description: Web Server node instance type
    Type: String
  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-windows-latest/Windows_Server-2016-English-Full-Base
  WebServerSecurityGroup:
    Description: Web Server Security Group
    Type: AWS::EC2::SecurityGroup::Id
  KeyPair:
    ConstraintDescription: Must be the name of an existing EC2 KeyPair.
    Default: id_rsa_aws
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances
    Type: AWS::EC2::KeyPair::KeyName
  DomainNameURL:
    Description: The fully qualified domain name to be used for this ODS API environment
    Type: String
  DBEndpointAddress:
    Description: RDS DB Endpoint
    Type: String
  DBUsername:
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric
      characters.
    Default: sqlsa
    Description: The database account username
    MaxLength: '16'
    MinLength: '1'
    Type: String
  DBPassword:
    AllowedPattern: (?=\S)[^@/"\r\n\t\f\s]*
    ConstraintDescription: Min 8 chars.
    Description: The database account password
    MaxLength: '41'
    MinLength: '8'
    NoEcho: 'True'
    Type: String
  VPCID:
    Description: Select the VPC to use
    Type: AWS::EC2::VPC::Id
Rules:
  SubnetsInVPC:
    Assertions:
      - Assert: !EachMemberIn
          - !ValueOfAll
            - AWS::EC2::Subnet::Id
            - VpcId
          - !RefAll 'AWS::EC2::VPC::Id'
        AssertDescription: All subnets provided must in the VPC selected for use
Resources:
  WebServerInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
  WebServerInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref 'WebServerInstanceRole'
  WebServerIAMPolicy:
    Type: AWS::IAM::Policy
    DependsOn:
      - WebServerInstanceRole
    Properties:
      PolicyName: !Join
        - ''
        - - AppServerIAMPolicy
          - '-'
          - !Ref 'EnvLabel'
          - -policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Action:
              - s3:List*
              - s3:GetObject
            Effect: Allow
            Resource:
              - !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref 'S3BucketName'
              - !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref 'S3BucketName'
                  - /*
      Roles:
        - !Ref 'WebServerInstanceRole'
  WebServerInstance:
    Type: AWS::EC2::Instance
    Metadata:
      AWS::CloudFormation::Authentication:
        S3AccessCreds:
          type: S3
          buckets:
            - !Ref 'S3BucketName'
          roleName: !Ref 'WebServerInstanceRole'
      AWS::CloudFormation::Init:
        configSets:
          defaultorder:
            - config1
            - config2
        config1:
          files:
            c:\cfn\cfn-hup.conf:
              content: !Join
                - ''
                - - "[main]\n"
                  - stack=
                  - !Ref 'AWS::StackName'
                  - "\n"
                  - region=
                  - !Ref 'AWS::Region'
                  - "\n"
            c:\cfn\hooks.d\cfn-auto-reloader.conf:
              content: !Join
                - ''
                - - "[cfn-auto-reloader-hook]\n"
                  - "triggers=post.update\n"
                  - "path=Resources.WebServerInstance.Metadata.AWS::CloudFormation::Init\n"
                  - 'action=cfn-init.exe -v -s '
                  - !Ref 'AWS::StackName'
                  - ' -r WebServerInstance'
                  - ' --region '
                  - !Ref 'AWS::Region'
                  - "\n"
            C:\ODS-API-and-Swagger-Server-Install.ps1:
              source: !Join
                - ''
                - - https://
                  - !Ref 'S3BucketName'
                  - .s3.amazonaws.com/scripts/ODS-API-and-Swagger-Server-Install.ps1
            C:\Admin-App-Install.ps1:
              source: !Join
                - ''
                - - https://
                  - !Ref 'S3BucketName'
                  - .s3.amazonaws.com/scripts/Admin-App-Install.ps1
            C:\Create-LocalUser.ps1:
              source: !Join
                - ''
                - - https://
                  - !Ref 'S3BucketName'
                  - .s3.amazonaws.com/scripts/Create-LocalUser.ps1
          commands:
            a-create-admin:
              command: !Join
                - ''
                - - 'powershell.exe -Command c:\Create-LocalUser.ps1 -AdminUser '
                  - !Ref 'AdminUser'
                  - ' -AdminPassword '
                  - ''''
                  - !Ref 'AdminPassword'
                  - ''''
              waitAfterCompletion: '0'
            b-set-admin-group:
              command: !Join
                - ''
                - - 'net localgroup Administrators '
                  - !Ref 'AdminUser'
                  - ' /ADD'
              waitAfterCompletion: '0'
        config2:
          commands:
            1-executeinstall:
              command: !Join
                - ''
                - - powershell -command C:\ODS-API-and-Swagger-Server-Install.ps1
                    -verb runas -DatabaseHost '
                  - !Ref 'DBEndpointAddress'
                  - ''' -DatabaseUser '''
                  - !Ref 'DBUsername'
                  - ''' -DatabasePassword '''
                  - !Ref 'DBPassword'
                  - ''' -DomainName '''
                  - !Ref 'DomainNameURL'
                  - ''' -InstallSwagger '''
                  - !Ref 'UseSwagger'
                  - ''' -S3Bucket '''
                  - !Ref 'S3BucketName'
                  - ''''
            2-executeinstall:
              command: !Join
                - ''
                - - powershell -command C:\Admin-App-Install.ps1 -verb runas -DatabaseHost
                    '
                  - !Ref 'DBEndpointAddress'
                  - ''' -DatabaseUser '''
                  - !Ref 'DBUsername'
                  - ''' -DatabasePassword '''
                  - !Ref 'DBPassword'
                  - ''' -AdminAppUserName '''
                  - !Ref 'AdminUser'
                  - ''' -AdminAppPassword '''
                  - !Ref 'AdminPassword'
                  - ''' -InstallSwagger '''
                  - !Ref 'UseSwagger'
                  - ''' -InstallNonProd ''yes'' -DomainName ''localhost'' -S3Bucket
                    '''
                  - !Ref 'S3BucketName'
                  - ''''
          services:
            windows:
              cfn-hup:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - c:\cfn\cfn-hup.conf
                  - c:\cfn\hooks.d\cfn-auto-reloader.conf
    Properties:
      ImageId: !Ref 'LatestAmiId'
      InstanceType: !Ref 'WebServerInstanceType'
      IamInstanceProfile: !Ref 'WebServerInstanceProfile'
      SecurityGroupIds:
        - !Ref 'WebServerSecurityGroup'
      SubnetId: !Ref 'WebServerSubnetId'
      KeyName: !Ref 'KeyPair'
      Tags:
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'AWS::StackName'
              - App and Admin Server
              - !Ref 'EnvLabel'
        - Key: Environment
          Value: !Ref 'EnvLabel'
      UserData: !Base64
        Fn::Join:
          - ''
          - - "<script>\n"
            - 'cfn-init.exe -v -s '
            - !Ref 'AWS::StackName'
            - ' -r WebServerInstance -c defaultorder'
            - ' --region '
            - !Ref 'AWS::Region'
            - "\n"
            - 'cfn-signal.exe -e %ERRORLEVEL% '
            - ' --stack '
            - !Ref 'AWS::StackId'
            - ' --resource WebServerInstance'
            - ' --region '
            - !Ref 'AWS::Region'
            - "\n"
            - </script>
Outputs:
  Ec2InstanceId:
    Description: Instance ID for the EC2 NonProd Server
    Value: !Ref 'WebServerInstance'
    Export:
      Name: !Sub '${AWS::StackName}-Ec2InstanceId'
